<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mycology Lab Spreadsheet</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #111827; color: #fff; }
    .card { background: #1F2937; border-radius: 1.25rem; box-shadow: 0 2px 16px #0005; max-height: 75vh; display: flex; flex-direction: column; overflow: visible; margin-bottom: 2rem; transition: box-shadow 0.2s;}
    .card:hover { box-shadow: 0 6px 24px #2563eb44; }
    .card-expandable-content { flex: 1 1 auto; min-height: 0; overflow-y: auto; max-height: 40vh; margin-top: 0.5rem; margin-bottom: 0.5rem; scrollbar-width: thin;}
    .tab-scrollable, .card-expandable-content { scrollbar-width: thin; -ms-overflow-style: none; }
    .tab-scrollable::-webkit-scrollbar, .card-expandable-content::-webkit-scrollbar { display: none; }
    .btn, .btn-secondary { border-radius: 0.75rem; padding: 0.65rem 1.45rem; color: #fff; transition: background 0.2s, box-shadow 0.15s, transform 0.1s; font-weight: 600; font-size: 1.08rem; outline: none; border: none; box-shadow: 0 2px 8px #0002; margin-bottom: 0.15rem; cursor: pointer; }
    .btn { background: linear-gradient(90deg, #2563eb 80%, #1e40af 100%); }
    .btn:active, .btn:focus { transform: scale(0.97); box-shadow: 0 4px 16px #2563eb66; }
    .btn-secondary { background: #374151; }
    .btn-secondary:hover, .btn-secondary:focus { background: #2563eb; color: #fff; }
    .btn-danger, .btn-delete { background: linear-gradient(90deg, #dc2626 80%, #b91c1c 100%); color: #fff; border-radius: 0.75rem; border: none; font-size: 0.98rem; padding: 0.28rem 1.1rem; font-weight: 600; transition: background 0.15s, transform 0.1s; margin: 0; outline: none; box-shadow: 0 2px 8px #0002; cursor: pointer;}
    .btn-danger:active, .btn-danger:focus, .btn-danger:hover, .btn-delete:active, .btn-delete:focus, .btn-delete:hover { background: #b91c1c; color: #fff; box-shadow: 0 2px 8px #0005; outline: none; transform: scale(0.97);}
    .input { background: #232c3a; color: #fff; border-radius: 0.75rem; padding: 0.65rem; border: 1.5px solid #232c3a; font-size: 1.025rem; outline: none; box-shadow: 0 2px 8px #0001; margin-bottom: 0.15rem; transition: border 0.14s, box-shadow 0.12s;}
    .input:focus { border: 1.5px solid #2563eb; box-shadow: 0 4px 16px #2563eb33; }
    .input[readonly] { opacity: 0.7; background: #232c3a; cursor: not-allowed; }
    .table-header { background: #111827; }
    .notification { position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%); background: #1F2937; color: #fff; padding: 1rem 2rem; border-radius: 0.7rem; display: none; box-shadow: 0 2px 12px #2563ebbb; z-index: 1000; font-weight: 600; letter-spacing: 0.04em; font-size: 1.1rem; animation: fadeInOut 2s;}
    @keyframes fadeInOut { 0% { opacity: 0;} 10% { opacity: 1;} 90% { opacity: 1;} 100% { opacity: 0;}}
    .tab-btn-active { position: relative; color: #fff; background: linear-gradient(90deg, #2563eb 80%, #1e40af 100%); box-shadow: 0 2px 12px #1e40af77;}
    .tab-btn-active::after { content: ""; position: absolute; left: 12%; bottom: -6px; width: 76%; height: 4px; background: #2563eb; border-radius: 2px 2px 12px 12px; animation: indicatorIn 0.4s;}
    @keyframes indicatorIn { from { width: 0; } to { width: 76%; } }
    .run-supply-input { width: 70px; background: #262f3f; color: #fff; border-radius: 0.5rem; border: 1.5px solid #374151; padding: 0.35rem 0.5rem; transition: border 0.14s;}
    .run-supply-input:focus { border: 1.5px solid #2563eb; }
    .ml-hint { font-size: 0.88rem; color: #fbbf24; margin-left: 0.5rem; }
    .side-menu { display: flex; flex-direction: column; position: fixed; left: 0; top: 0; height: 100vh; width: 270px; background: #1F2937; box-shadow: 2px 0 12px #0005; padding: 0; z-index: 101; transform: translateX(-100%); transition: transform 0.2s; gap: 0; border-top-right-radius: 1.3rem; border-bottom-right-radius: 1.3rem;}
    .side-menu.open { transform: translateX(0); }
    .side-menu-header { font-size: 1.4rem; font-weight: bold; padding: 1.2rem 1.5rem 1rem 1.5rem; color: #fff; border-bottom: 1px solid #374151;}
    .side-menu .menu-btn { display: block; width: 100%; text-align: left; padding: 0.95rem 1.5rem; background: none; border: none; color: #fff; font-size: 1.08rem; cursor: pointer; border-bottom: 1px solid #232c3a; transition: background 0.13s, color 0.13s; border-radius: 0; font-weight: 500; outline: none; margin: 0;}
    .side-menu .menu-btn:active, .side-menu .menu-btn:focus, .side-menu .menu-btn:hover { background: #2563eb; color: #fff;}
    .side-menu-version { margin-top: auto; color: #a1a1aa; text-align: center; font-size: 1.1rem; padding: 0 0 1.2rem 0; border-top: 1px solid #232c3a; padding-top: 0.7rem; letter-spacing: 0.05em;}
    .hamburger { width: 54px; height: 54px; background: #232c3a; border: none; display: flex; align-items: center; justify-content: center; position: fixed; left: 1.5rem; top: 1.7rem; z-index: 1102; cursor: pointer; flex-direction: column; gap: 7px; border-radius: 50%; box-shadow: 0 2px 12px #0004; transition: background 0.12s;}
    .hamburger-bar { display: block; width: 32px; height: 4px; background: #fff; border-radius: 3px; transition: all 0.2s;}
    .hamburger.hide { display: none !important; }
    .side-menu-bg { position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; background: #000a; z-index: 100; display: none; transition: opacity 0.2s;}
    .side-menu-bg.open { display: block; }
    @media (max-width: 900px) {
      #runFormRow { flex-direction: column; align-items: stretch; }
      #runFormRow > * { width: 100% !important; margin-left: 0 !important; }
      .side-menu { width: 95vw; min-width: 0; border-radius: 0 1.3rem 1.3rem 0; }
      .card { max-height: calc(100vh - 3rem); }
    }
    .modal-bg { position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; background: #000a; z-index: 5000; display: none; align-items: center; justify-content: center;}
    .modal-bg.open { display: flex; }
    .modal { background: #1F2937; border-radius: 1.25rem; box-shadow: 0 2px 16px #0008; padding: 2rem 2rem 1.5rem 2rem; min-width: 320px; max-width: 90vw; color: #fff; position: relative; text-align: left; animation: fadeInOut 0.6s;}
    .modal-close { position: absolute; top: 0.5rem; right: 0.8rem; background: none; border: none; color: #fff; font-size: 1.8rem; cursor: pointer; transition: color 0.13s;}
    .modal-close:hover { color: #dc2626; }
    .modal-btn-row { display: flex; gap: 1rem; margin-top: 1rem; }
    input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0;}
    input[type="number"] { -moz-appearance: textfield; }
  </style>
</head>
<body class="flex flex-col items-center min-h-screen py-10">

<!-- Hamburger always visible -->
<button id="hamburgerBtn" class="hamburger" onclick="toggleMenu()" aria-label="Open menu">
  <span class="hamburger-bar"></span>
  <span class="hamburger-bar"></span>
  <span class="hamburger-bar"></span>
</button>
<div id="sideMenuBg" class="side-menu-bg"></div>
<nav id="sideMenu" class="side-menu" aria-label="Main menu" tabindex="-1">
  <div class="side-menu-header">Menu</div>
  <button type="button" class="menu-btn" id="exportBtn">Export / Save</button>
  <button type="button" class="menu-btn" id="importBtn">Import / Load</button>
  <div class="side-menu-version">v0.02.04 Stable Release</div>
</nav>
<a id="realDownloadAnchor" style="display:none"></a>
<div id="notification" class="notification"></div>
<div id="fruitModalBg" class="modal-bg" tabindex="-1">
  <div class="modal" id="fruitModal">
    <button class="modal-close" id="fruitModalClose" onclick="closeFruitModal()" aria-label="Close">&times;</button>
    <div id="fruitModalContent"></div>
  </div>
</div>

<div id="mainContent" class="w-full flex flex-col items-center">
  <div class="w-full max-w-5xl card p-6 mb-6">
    <h1 class="text-2xl font-bold mb-2 text-center">Mycology Lab Spreadsheet</h1>
    <div class="flex flex-wrap gap-4 justify-center mb-4">
      <div class="card p-4 flex-1 min-w-[220px]">
        <div class="text-sm text-gray-400">Supplies in Inventory</div>
        <div id="suppliesCount" class="text-xl font-semibold"></div>
      </div>
      <div class="card p-4 flex-1 min-w-[220px]">
        <div class="text-sm text-gray-400">Mushroom Stock (g)</div>
        <div id="mushroomStock" class="text-xl font-semibold flex items-center"></div>
      </div>
      <div class="card p-4 flex-1 min-w-[220px]">
        <div class="text-sm text-gray-400">Total Expenses</div>
        <div id="totalExpenses" class="text-xl font-semibold"></div>
      </div>
      <div class="card p-4 flex-1 min-w-[220px]">
        <div class="text-sm text-gray-400">Total Profit</div>
        <div id="totalProfit" class="text-xl font-semibold"></div>
      </div>
    </div>
    <div class="flex gap-4 justify-center flex-wrap">
      <button id="btn-inventory" class="btn tab-btn-active" onclick="showTab('inventory')">Inventory</button>
      <button id="btn-runs" class="btn-secondary" onclick="showTab('runs')">Production Runs</button>
      <button id="btn-spawn" class="btn-secondary" onclick="showTab('spawn')">Spawn</button>
      <button id="btn-colonizing" class="btn-secondary" onclick="showTab('colonizing')">Colonizing</button>
      <button id="btn-fruiting" class="btn-secondary" onclick="showTab('fruiting')">Fruiting</button>
    </div>
  </div>
  <!-- Inventory Tab -->
  <div id="tab-inventory" class="w-full max-w-5xl card p-6 mb-6">
    <h2 class="text-xl font-bold mb-4">Supplies Inventory</h2>
    <form onsubmit="event.preventDefault(); addSupply();">
      <div class="flex flex-wrap gap-4 mb-2">
        <input id="supplyName" class="input flex-1" placeholder="Supply Name (e.g. Peat moss)">
        <input id="supplyQty" class="input w-28" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" placeholder="Quantity">
        <input id="supplyUnit" class="input w-24" placeholder="Unit" oninput="showMlHint()">
        <input id="supplyUnitCost" class="input w-32" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" placeholder="Cost Per Unit">
        <button type="submit" class="btn">Add / Update</button>
        <span id="mlHint" class="ml-hint" style="display:none;">For <b>ml</b>: Enter the total price for all ml, not per ml!</span>
      </div>
      <div class="text-xs text-gray-400 mb-2">If supply exists, quantity will be increased. Units and cost will be updated.</div>
    </form>
    <div class="card-expandable-content overflow-x-auto">
      <table class="w-full mt-4 text-left">
        <thead>
          <tr class="table-header">
            <th class="p-2">Supply</th>
            <th class="p-2">Quantity</th>
            <th class="p-2">Unit</th>
            <th class="p-2">Unit Cost</th>
            <th class="p-2">Total Cost</th>
            <th class="p-2"></th>
          </tr>
        </thead>
        <tbody id="suppliesTable"></tbody>
      </table>
    </div>
  </div>
  <!-- Runs Tab -->
  <div id="tab-runs" class="w-full max-w-5xl card p-6 mb-6 hidden">
    <div class="tab-scrollable">
      <h2 class="text-xl font-bold mb-4">Production Runs</h2>
      <form id="runForm" onsubmit="event.preventDefault(); addRun();">
        <div id="runFormRow" class="flex flex-row gap-2 mb-2 items-center w-full">
          <input id="runName" class="input flex-1 min-w-32" placeholder="Run Description">
          <input id="runDate" class="input w-40" type="date" placeholder="Run Date">
          <button type="submit" class="btn ml-auto">Add Run</button>
        </div>
        <div class="card-expandable-content overflow-x-auto mt-3 mb-3">
          <table class="w-full text-left">
            <thead>
              <tr class="table-header">
                <th class="p-2">Supply</th>
                <th class="p-2">Available</th>
                <th class="p-2">Unit</th>
                <th class="p-2">Use for this Run</th>
              </tr>
            </thead>
            <tbody id="runSuppliesTable"></tbody>
          </table>
        </div>
      </form>
      <div class="card-expandable-content overflow-x-auto">
        <table class="w-full mt-4 text-left">
          <thead>
            <tr class="table-header">
              <th class="p-2">Run</th>
              <th class="p-2">Supplies Used</th>
              <th class="p-2">Run Date</th>
              <th class="p-2">Total Cost</th>
              <th class="p-2"></th>
            </tr>
          </thead>
          <tbody id="runsTable"></tbody>
        </table>
      </div>
    </div>
  </div>
  <!-- Spawn Tab -->
  <div id="tab-spawn" class="w-full max-w-5xl card p-6 mb-6 hidden">
    <div class="tab-scrollable">
      <h2 class="text-xl font-bold mb-4">Spawn (Grain Jar Inventory)</h2>
      <form id="spawnForm" onsubmit="event.preventDefault(); addSpawnJar();">
        <div class="flex flex-wrap gap-4 mb-2">
          <input id="spawnStrain" class="input flex-1" placeholder="Strain (e.g. Golden Teacher)">
          <input id="spawnJarId" class="input w-20" placeholder="Jar ID">
          <input id="spawnDate" class="input w-40" type="date" placeholder="Inoculation Date">
          <button type="submit" class="btn">Add Jar</button>
        </div>
        <div class="text-xs text-gray-400 mb-2">
          Track all jars by strain and date. These jars can be moved to Colonizing.
        </div>
      </form>
      <div class="card-expandable-content overflow-x-auto">
        <table class="w-full mt-4 text-left">
          <thead>
            <tr class="table-header">
              <th class="p-2">Strain</th>
              <th class="p-2">Jar ID</th>
              <th class="p-2">Inoculation Date</th>
              <th class="p-2"></th>
            </tr>
          </thead>
          <tbody id="spawnTable"></tbody>
        </table>
      </div>
    </div>
  </div>
  <!-- Colonizing Tab -->
  <div id="tab-colonizing" class="w-full max-w-5xl card p-6 mb-6 hidden">
    <div class="tab-scrollable">
      <h2 class="text-xl font-bold mb-4">Colonizing Tubs</h2>
      <form id="colonizingForm" onsubmit="event.preventDefault(); addColonizingTub();">
        <div class="flex flex-wrap gap-4 mb-2">
          <select id="colonizeSpawnJarId" class="input w-24"></select>
          <input id="colonizeSpecies" class="input flex-1" readonly placeholder="Strain">
          <input id="colonizeOuttakeDate" class="input w-40" type="date" placeholder="Planned Outtake Date">
          <button type="submit" class="btn">Add Tub</button>
        </div>
        <div class="text-xs text-gray-400 mb-2">
          Select a Spawn Jar to colonize. Outtake = planned transfer to fruiting (you select this). Inoculation date is always set to today automatically.
        </div>
      </form>
      <div class="card-expandable-content overflow-x-auto">
        <table class="w-full mt-4 text-left">
          <thead>
            <tr class="table-header">
              <th class="p-2">Strain</th>
              <th class="p-2">Tub ID</th>
              <th class="p-2">Inoculation Date</th>
              <th class="p-2">Outtake Date</th>
              <th class="p-2">Source Jar</th>
              <th class="p-2"></th>
            </tr>
          </thead>
          <tbody id="colonizingTable"></tbody>
        </table>
      </div>
    </div>
  </div>
  <!-- Fruiting Tab -->
  <div id="tab-fruiting" class="w-full max-w-5xl card p-6 mb-6 hidden">
    <div class="tab-scrollable">
      <h2 class="text-xl font-bold mb-4">Fruiting</h2>
      <form id="fruitFlushForm" onsubmit="event.preventDefault();">
        <!-- This form is dynamically created in the modal -->
      </form>
      <form onsubmit="event.preventDefault(); addFruitingTub();">
        <div class="flex flex-wrap gap-4 mb-2">
          <select id="fruitingTubId" class="input w-24"></select>
          <input id="fruitingSpecies" class="input flex-1" readonly placeholder="Species">
          <input id="fruitingHarvestDate" class="input w-40" type="date" placeholder="Date Moved to Fruiting">
          <button type="submit" class="btn">Move to Fruiting</button>
        </div>
        <div class="text-xs text-gray-400 mb-2">Select Tub ID to move from colonizing to fruiting. Only colonizing tubs appear here.</div>
      </form>
      <div class="card-expandable-content overflow-x-auto">
        <table class="w-full mt-4 text-left">
          <thead>
            <tr class="table-header">
              <th class="p-2">Tub ID</th>
              <th class="p-2">Species</th>
              <th class="p-2">Fruiting Start Date</th>
              <th class="p-2">Flush #</th>
              <th class="p-2"></th>
            </tr>
          </thead>
          <tbody id="fruitingTable"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<script>
let data = {
  supplies: [],
  runs: [],
  mushrooms: 0,
  spawn: [],
  colonizing: [],
  fruiting: [],
  marketPrice: 20,
  harvestedTubs: [],
  tubFlushes: {},
  profit: 0,
  expenses: 0,
  profitLog: [],
};

function saveData() { localStorage.setItem('mycologyLabData', JSON.stringify(data)); }
function loadData() { const d = localStorage.getItem('mycologyLabData'); if (d) data = JSON.parse(d); }
loadData();

function showNotification(msg, error = false) {
  const n = document.getElementById('notification');
  n.textContent = msg;
  n.style.background = error ? '#dc2626' : '#1F2937';
  n.style.display = 'block';
  setTimeout(() => n.style.display = 'none', 2000);
}
function ordinal(n) {
  if(n%100>=11 && n%100<=13) return n + "th";
  switch(n%10){
    case 1: return n + "st";
    case 2: return n + "nd";
    case 3: return n + "rd";
    default: return n + "th";
  }
}

// ---- MENU ----
function toggleMenu() {
  const menu = document.getElementById('sideMenu');
  const bg = document.getElementById('sideMenuBg');
  const hamburger = document.getElementById('hamburgerBtn');
  const isOpen = menu.classList.contains('open');
  if (isOpen) {
    menu.classList.remove('open');
    bg.classList.remove('open');
    hamburger.classList.remove('hide');
  } else {
    menu.classList.add('open');
    bg.classList.add('open');
    hamburger.classList.add('hide');
  }
}
function closeMenu() {
  document.getElementById('sideMenu').classList.remove('open');
  document.getElementById('sideMenuBg').classList.remove('open');
  document.getElementById('hamburgerBtn').classList.remove('hide');
}
document.getElementById('sideMenuBg').addEventListener('mousedown', function(e){
  if (e.target === this) closeMenu();
});
document.querySelectorAll('.side-menu .menu-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    closeMenu();
  });
});

// ---- TABS ----
function showTab(tab) {
  ['inventory', 'runs', 'spawn', 'colonizing', 'fruiting'].forEach(t => {
    document.getElementById('tab-' + t).classList.add('hidden');
    const btn = document.getElementById('btn-' + t);
    if (btn) {
      if (t === tab) {
        btn.classList.remove('btn-secondary');
        btn.classList.add('btn', 'tab-btn-active');
      } else {
        btn.classList.remove('btn', 'tab-btn-active');
        btn.classList.add('btn-secondary');
      }
    }
  });
  document.getElementById('tab-' + tab).classList.remove('hidden');
  updateDashboard();
  if (tab === 'inventory') { renderSupplies(); }
  if (tab === 'runs') { renderRuns(); renderRunSuppliesTable(); }
  if (tab === 'spawn') { renderSpawn(); }
  if (tab === 'colonizing') { renderColonizing(); updateColonizeSpawnSelect(); updateNextTubId(); }
  if (tab === 'fruiting') { renderFruiting(); updateFruitingTubSelect(); }
  closeMenu();
}
document.addEventListener("DOMContentLoaded", function() {
  showTab('inventory');
  updateDashboard();
  renderSupplies();
  renderRuns();
  renderSpawn();
  renderColonizing();
  renderFruiting();
  renderRunSuppliesTable && renderRunSuppliesTable();
  updateColonizeSpawnSelect && updateColonizeSpawnSelect();
  updateNextTubId && updateNextTubId();
  updateFruitingTubSelect && updateFruitingTubSelect();
});

// ---- DASHBOARD / FINANCIALS ----
function updateDashboard() {
  document.getElementById('suppliesCount').textContent = data.supplies.filter(s=>!s.deleted).length;
  document.getElementById('mushroomStock').textContent = data.mushrooms.toFixed(2);
  document.getElementById('totalExpenses').textContent = "$" + data.expenses.toFixed(2);
  document.getElementById('totalProfit').textContent = "$" + data.profit.toFixed(2);
  saveData();
}

// ---- INVENTORY ----
function showMlHint() {
  const unit = document.getElementById('supplyUnit').value.trim().toLowerCase();
  document.getElementById('mlHint').style.display = (unit === 'ml') ? '' : 'none';
}
function findSupplyIndex(name, unit) {
  return data.supplies.findIndex(s => !s.deleted && s.name.trim().toLowerCase() === name.trim().toLowerCase() && s.unit.trim().toLowerCase() === unit.trim().toLowerCase());
}
function addSupply() {
  const name = document.getElementById('supplyName').value.trim();
  const qtyToAddStr = document.getElementById('supplyQty').value.trim().replace(",", ".");
  const qtyToAdd = +qtyToAddStr;
  const unit = document.getElementById('supplyUnit').value.trim();
  let unitCostInputStr = document.getElementById('supplyUnitCost').value.trim().replace(",", ".");
  let unitCostInput = +unitCostInputStr;
  if (!name || qtyToAdd <= 0 || unitCostInput < 0 || !unit) return showNotification('Invalid supply entry', true);
  let unitCost = unit.toLowerCase() === 'ml'
    ? (qtyToAdd > 0 ? unitCostInput / qtyToAdd : 0)
    : unitCostInput;
  let idx = findSupplyIndex(name, unit);
  if (idx !== -1) {
    data.supplies[idx].qty += qtyToAdd;
    data.supplies[idx].unitCost = unitCost;
    data.supplies[idx].deleted = false;
  } else {
    data.supplies.push({ name, qty: qtyToAdd, unit, unitCost, deleted: false });
  }
  saveData();
  renderSupplies();
  updateDashboard();
  renderRunSuppliesTable();
  document.getElementById('supplyName').value = '';
  document.getElementById('supplyQty').value = '';
  document.getElementById('supplyUnit').value = '';
  document.getElementById('supplyUnitCost').value = '';
  showMlHint();
  showNotification('Supply added/updated');
}
function deleteSupply(i) {
  data.supplies[i].deleted = true;
  saveData();
  renderSupplies();
  updateDashboard();
  renderRunSuppliesTable();
  showNotification('Supply deleted');
}
function renderSupplies() {
  const table = document.getElementById('suppliesTable');
  table.innerHTML = '';
  data.supplies.forEach((s, i) => {
    if (s.deleted) return;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="p-2">${s.name}</td>
      <td class="p-2">${s.qty}</td>
      <td class="p-2">${s.unit}</td>
      <td class="p-2">$${parseFloat(s.unitCost).toFixed(2)}</td>
      <td class="p-2">$${(s.qty * s.unitCost).toFixed(2)}</td>
      <td class="p-2"><button class="btn-delete" onclick="deleteSupply(${i})">Delete</button></td>
    `;
    table.appendChild(tr);
  });
}

// ---- RUNS ----
function renderRunSuppliesTable() {
  const table = document.getElementById('runSuppliesTable');
  if (!table) return;
  table.innerHTML = '';
  data.supplies.forEach((s, i) => {
    if (s.deleted) return;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="p-2">${s.name}</td>
      <td class="p-2">${s.qty} ${s.unit}</td>
      <td class="p-2">${s.unit}</td>
      <td class="p-2">
        <input type="number" min="0" step="any" class="run-supply-input" id="runSupplyUse${i}">
      </td>
    `;
    table.appendChild(tr);
  });
}
function addRun() {
  const name = document.getElementById('runName').value.trim();
  const runDate = document.getElementById('runDate').value.trim();
  if (!name || !runDate) return showNotification('Invalid run', true);
  let suppliesUsed = [];
  let totalCost = 0;
  let atLeastOneSupply = false;
  data.supplies.forEach((s, i) => {
    if (s.deleted) { suppliesUsed[i] = 0; return; }
    let val = document.getElementById('runSupplyUse'+i);
    let use = val && val.value ? +val.value.trim().replace(",", ".") : 0;
    if (isNaN(use) || use < 0) use = 0;
    if (use > s.qty) use = s.qty;
    suppliesUsed[i] = use;
    if (use > 0) {
      totalCost += use * s.unitCost;
      s.qty -= use;
      atLeastOneSupply = true;
    }
  });
  if (!atLeastOneSupply) return showNotification('Invalid run', true);
  data.expenses += totalCost;
  data.profit -= totalCost;
  data.profitLog.push({
    type: "run",
    amount: -totalCost,
    date: new Date().toISOString(),
    desc: `Run "${name}" on ${runDate}, supplies: [${suppliesUsed.map((u, i) => u > 0 ? data.supplies[i].name + ' x' + u : '').filter(Boolean).join(', ')}]`
  });
  data.runs.push({ name, time: Date.now(), suppliesUsed, runDate, totalCost, deleted: false });
  saveData();
  renderRuns();
  renderSupplies();
  updateDashboard();
  renderRunSuppliesTable();
  document.getElementById('runName').value = '';
  document.getElementById('runDate').value = '';
  showNotification('Run added');
}
function deleteRun(i) {
  data.runs[i].deleted = true;
  saveData();
  renderRuns();
  updateDashboard();
  showNotification('Run deleted');
}
function renderRuns() {
  const table = document.getElementById('runsTable');
  table.innerHTML = '';
  data.runs.forEach((run, i) => {
    if (run.deleted) return;
    const usedList = run.suppliesUsed.map((u, j) =>
      u > 0 && data.supplies[j] && !data.supplies[j].deleted
        ? `${data.supplies[j].name} (${u} ${data.supplies[j].unit})`
        : ''
    ).filter(Boolean).join(', ');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="p-2">${run.name}</td>
      <td class="p-2">${usedList}</td>
      <td class="p-2">${run.runDate || '-'}</td>
      <td class="p-2">$${run.totalCost.toFixed(2)}</td>
      <td class="p-2"><button class="btn-delete" onclick="deleteRun(${i})">Delete</button></td>
    `;
    table.appendChild(tr);
  });
}

// ---- SPAWN ----
function addSpawnJar() {
  const strain = document.getElementById('spawnStrain').value.trim();
  const jarId = document.getElementById('spawnJarId').value.trim();
  const date = document.getElementById('spawnDate').value.trim();
  if (!strain || !jarId || !date) return showNotification('Invalid jar entry', true);
  data.spawn.push({ strain, jarId, date, deleted: false });
  saveData();
  renderSpawn();
  updateColonizeSpawnSelect();
  document.getElementById('spawnStrain').value = '';
  document.getElementById('spawnJarId').value = '';
  document.getElementById('spawnDate').value = '';
  showNotification('Jar added');
}
function deleteSpawnJar(i) {
  data.spawn[i].deleted = true;
  saveData();
  renderSpawn();
  updateColonizeSpawnSelect();
  showNotification('Jar deleted');
}
function renderSpawn() {
  const table = document.getElementById('spawnTable');
  table.innerHTML = '';
  data.spawn.forEach((jar, i) => {
    if (jar.deleted) return;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="p-2">${jar.strain}</td>
      <td class="p-2">${jar.jarId}</td>
      <td class="p-2">${jar.date}</td>
      <td class="p-2"><button class="btn-delete" onclick="deleteSpawnJar(${i})">Delete</button></td>
    `;
    table.appendChild(tr);
  });
}
function updateColonizeSpawnSelect() {
  const sel = document.getElementById('colonizeSpawnJarId');
  if (!sel) return;
  sel.innerHTML = '';
  let options = data.spawn.filter(j => !j.deleted);
  options.forEach(j => {
    let opt = document.createElement('option');
    opt.value = j.jarId;
    opt.textContent = j.jarId;
    sel.appendChild(opt);
  });
  document.getElementById('colonizeSpecies').value = options.length ? options[0].strain : '';
}
document.addEventListener('DOMContentLoaded', function() {
  let colonizeSpawnJarId = document.getElementById('colonizeSpawnJarId');
  if (colonizeSpawnJarId) {
    colonizeSpawnJarId.addEventListener('change', function() {
      let j = data.spawn.find(j => j.jarId === this.value && !j.deleted);
      document.getElementById('colonizeSpecies').value = j ? j.strain : '';
    });
  }
});

// ---- COLONIZING ----
function addColonizingTub() {
  const spawnJarId = document.getElementById('colonizeSpawnJarId').value.trim();
  const strain = document.getElementById('colonizeSpecies').value.trim();
  const outtakeDate = document.getElementById('colonizeOuttakeDate').value.trim();
  if (!strain || !outtakeDate || !spawnJarId) return showNotification('Invalid tub', true);
  let today = new Date().toISOString().split('T')[0];
  let spawnIdx = data.spawn.findIndex(j => j.jarId === spawnJarId && !j.deleted);
  if (spawnIdx !== -1) data.spawn[spawnIdx].deleted = true;
  data.colonizing.push({
    strain,
    tubId: spawnJarId,
    inocDate: today,
    outtakeDate,
    spawnJarId,
    deleted: false
  });
  saveData();
  renderColonizing();
  updateColonizeSpawnSelect();
  updateFruitingTubSelect();
  document.getElementById('colonizeOuttakeDate').value = '';
  showNotification('Tub added');
}
function deleteColonizingTub(i) {
  data.colonizing[i].deleted = true;
  saveData();
  renderColonizing();
  updateFruitingTubSelect();
  showNotification('Tub deleted');
}
function renderColonizing() {
  const table = document.getElementById('colonizingTable');
  table.innerHTML = '';
  data.colonizing.forEach((tub, i) => {
    if (tub.deleted) return;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="p-2">${tub.strain}</td>
      <td class="p-2">${tub.tubId}</td>
      <td class="p-2">${tub.inocDate}</td>
      <td class="p-2">${tub.outtakeDate}</td>
      <td class="p-2">${tub.spawnJarId || ''}</td>
      <td class="p-2"><button class="btn-delete" onclick="deleteColonizingTub(${i})">Delete</button></td>
    `;
    table.appendChild(tr);
  });
}
function updateNextTubId() {}

// ---- FRUITING ----
function renderFruiting() {
  const table = document.getElementById('fruitingTable');
  table.innerHTML = '';
  data.fruiting.forEach((f, i) => {
    if (f.deleted) return;
    let flushArr = data.tubFlushes && data.tubFlushes[f.tubId] ? data.tubFlushes[f.tubId] : [];
    let currentFlush = flushArr.length ? flushArr[flushArr.length - 1].flushNum : 0;
    let displayFlush = currentFlush ? ordinal(currentFlush) : '1st';
    table.innerHTML += `<tr>
      <td class="p-2">${f.tubId}</td>
      <td class="p-2">${f.species || f.strain}</td>
      <td class="p-2">${f.fruitingDate}</td>
      <td class="p-2">${displayFlush}</td>
      <td class="p-2">
        <button class="btn" onclick="openFruitModal(${i})">Log Fruit / Flush</button>
      </td>
    </tr>`;
  });
}
function openFruitModal(idx) {
  const tub = data.fruiting[idx];
  if (!tub || tub.deleted) return;
  let flushArr = data.tubFlushes[tub.tubId] || [];
  let flushHistoryHtml = '';
  if (flushArr.length > 0) {
    flushHistoryHtml = '<div class="mb-3"><b>Flush history:</b><ul class="list-disc pl-5">';
    flushArr.forEach(f => {
      if (f.dump) {
        flushHistoryHtml += `<li><span class="text-red-400">Tub dumped on ${f.date}</span></li>`;
      } else {
        flushHistoryHtml += `<li>${ordinal(f.flushNum)} flush, ${f.date}, ${f.grams}g</li>`;
      }
    });
    flushHistoryHtml += '</ul></div>';
  }
  document.getElementById('fruitModalContent').innerHTML = `
    <h2 class="text-lg font-bold mb-2">Log Flush for Tub <span class="text-blue-300">${tub.tubId}</span> (${tub.species || tub.strain})</h2>
    ${flushHistoryHtml}
    <form id="flushForm" onsubmit="event.preventDefault(); submitFlush(${idx});">
      <div class="mb-2">
        <label class="block mb-1">Flush number:</label>
        <input class="input w-28" id="flushNum" type="number" min="1" step="1" placeholder="e.g. 2" required>
      </div>
      <div class="mb-2">
        <label class="block mb-1">Flush date (start):</label>
        <input class="input w-44" type="date" id="flushDate" value="${(new Date()).toISOString().slice(0,10)}" required>
      </div>
      <div class="mb-2">
        <label class="block mb-1">Harvested (e.g. 80g):</label>
        <input class="input w-28" id="flushGrams" placeholder="0g" required>
      </div>
      <div class="modal-btn-row">
        <button type="submit" class="btn">Log Flush</button>
        <button type="button" class="btn btn-danger" onclick="dumpTub(${idx})">Dump Tub</button>
      </div>
    </form>
  `;
  document.getElementById('fruitModalBg').classList.add('open');
  let closeBtn = document.getElementById('fruitModalClose');
  if (closeBtn) closeBtn.onclick = closeFruitModal;
  document.getElementById('flushNum').focus();
}

function closeFruitModal() {
  document.getElementById('fruitModalBg').classList.remove('open');
  document.getElementById('fruitModalContent').innerHTML = '';
}

// Handles both flush and dump+flush (dumpTub calls this with grams if needed)
function logHarvestGrams(tub, grams, date) {
  if (!grams || grams <= 0) return;
  data.mushrooms += grams;
  let profitToAdd = (grams / 3.5) * 25;
  data.profit += profitToAdd;
  data.profitLog.push({
    type: "flush",
    amount: profitToAdd,
    date: date || (new Date()).toISOString().split('T')[0],
    desc: `Harvested ${grams}g on tub ${tub.tubId} (${tub.species || tub.strain})`
  });
}

function submitFlush(idx) {
  const tub = data.fruiting[idx];
  if (!tub || tub.deleted) return;
  const flushArr = data.tubFlushes[tub.tubId] = data.tubFlushes[tub.tubId] || [];
  let flushNum = parseInt(document.getElementById('flushNum').value.trim(), 10);
  const date = document.getElementById('flushDate').value;
  let gramsStr = document.getElementById('flushGrams').value.trim();
  let grams = 0;
  if (!/^[0-9]+(\.[0-9]+)?[gG]$/.test(gramsStr)) {
    showNotification("Please enter grams like '22g'", true); return;
  }
  grams = parseFloat(gramsStr.replace(/[gG]/, ''));
  if (!date || isNaN(grams) || grams < 0 || isNaN(flushNum) || flushNum < 1) {
    showNotification("Invalid flush entry", true); return;
  }
  flushArr.push({ flushNum, date, grams: gramsStr });
  logHarvestGrams(tub, grams, date);
  saveData();
  updateDashboard();
  renderFruiting();
  closeFruitModal();
  showNotification(`Logged ${ordinal(flushNum)} flush for tub ${tub.tubId}`);
}

function dumpTub(idx) {
  const tub = data.fruiting[idx];
  if (!tub || tub.deleted) return;
  let gramsStr = "";
  let grams = 0;
  let flushNum = 1;
  let date = (new Date()).toISOString().split('T')[0];
  if (document.getElementById('flushGrams')) {
    gramsStr = document.getElementById('flushGrams').value.trim();
    if (/^[0-9]+(\.[0-9]+)?[gG]$/.test(gramsStr)) {
      grams = parseFloat(gramsStr.replace(/[gG]/, ''));
      if (document.getElementById('flushNum')) {
        let n = parseInt(document.getElementById('flushNum').value.trim(), 10);
        if (!isNaN(n)) flushNum = n;
      }
      if (document.getElementById('flushDate')) {
        let d = document.getElementById('flushDate').value;
        if (d) date = d;
      }
      if (grams > 0) {
        const flushArr = data.tubFlushes[tub.tubId] = data.tubFlushes[tub.tubId] || [];
        flushArr.push({ flushNum, date, grams: gramsStr });
        logHarvestGrams(tub, grams, date);
      }
    }
  }
  // Now dump tub
  data.tubFlushes[tub.tubId] = data.tubFlushes[tub.tubId] || [];
  data.tubFlushes[tub.tubId].push({ dump: true, date: date });
  tub.harvested = true;
  tub.harvestedDate = date;
  data.harvestedTubs = data.harvestedTubs || [];
  data.harvestedTubs.push({
    tubId: tub.tubId,
    species: tub.species || tub.strain,
    fruitingDate: tub.fruitingDate,
    harvestedDate: tub.harvestedDate,
    status: "Dumped"
  });
  tub.deleted = true;
  saveData();
  renderFruiting();
  updateDashboard();
  closeFruitModal();
  showNotification('Tub dumped and removed');
}

function addFruitingTub() {
  const tubId = document.getElementById('fruitingTubId').value.trim();
  const species = document.getElementById('fruitingSpecies').value.trim();
  const fruitingDate = document.getElementById('fruitingHarvestDate').value.trim();
  if (!tubId || !species || !fruitingDate) return showNotification('Invalid fruiting move', true);
  let idx = data.colonizing.findIndex(t => t.tubId === tubId && !t.deleted);
  if (idx !== -1) { data.colonizing[idx].deleted = true; }
  data.fruiting.push({ tubId, species, fruitingDate, deleted: false });
  data.tubFlushes[tubId] = [];
  saveData();
  renderColonizing();
  renderFruiting();
  updateFruitingTubSelect();
  document.getElementById('fruitingHarvestDate').value = '';
  showNotification('Tub moved to fruiting');
}
function updateFruitingTubSelect() {
  const sel = document.getElementById('fruitingTubId');
  if (!sel) return;
  sel.innerHTML = '';
  let options = data.colonizing.filter(t => !t.deleted);
  options.forEach(t => {
    let opt = document.createElement('option');
    opt.value = t.tubId;
    opt.textContent = t.tubId;
    sel.appendChild(opt);
  });
  document.getElementById('fruitingSpecies').value = options.length ? (options[0].species || options[0].strain) : '';
}
document.addEventListener('DOMContentLoaded', function() {
  let fruitingTubId = document.getElementById('fruitingTubId');
  if (fruitingTubId) {
    fruitingTubId.addEventListener('change', function() {
      let t = data.colonizing.find(t => t.tubId === this.value && !t.deleted);
      document.getElementById('fruitingSpecies').value = t ? (t.species || t.strain) : '';
    });
  }
});

// ---- EXPORT/IMPORT ----
document.getElementById('exportBtn').onclick = function() {
  closeMenu();
  setTimeout(exportTextFile, 100);
};
document.getElementById('importBtn').onclick = function() {
  closeMenu();
  setTimeout(importTextFile, 100);
};
function exportTextFile() {
  let lines = [];
  lines.push('==== SUPPLIES ====');
  data.supplies.forEach(s => {
    let line = `${s.name} | ${s.qty} | ${s.unit} | ${parseFloat(s.unitCost).toFixed(2)}`;
    if (s.deleted) line += ' | DELETED';
    lines.push(line);
  });
  lines.push('');
  lines.push('==== SPAWN (GRAIN JARS) ====');
  data.spawn.forEach(j => {
    let line = `${j.strain} | ${j.jarId} | ${j.date}`;
    if (j.deleted) line += ' | DELETED';
    lines.push(line);
  });
  lines.push('');
  lines.push('==== COLONIZING ====');
  data.colonizing.forEach(tub => {
    let line = `${tub.strain} | ${tub.tubId} | ${tub.inocDate} | ${tub.outtakeDate} | ${tub.spawnJarId || ''}`;
    if (tub.deleted) line += ' | DELETED';
    lines.push(line);
  });
  lines.push('');
  lines.push('==== RUNS ====');
  data.runs.forEach(run => {
    let date = run.time ? new Date(run.time).toISOString() : '';
    let used = run.suppliesUsed
      .map((u, j) => (u > 0 && data.supplies[j] && !data.supplies[j].deleted) ? `${data.supplies[j]?.name || 'N/A'}:${u} ${data.supplies[j]?.unit || ''}` : '')
      .filter(Boolean).join(', ');
    let line = `${run.name} | ${date} | ${used} | ${run.runDate} | ${run.totalCost}`;
    lines.push(line);
  });
  lines.push('');
  lines.push('==== PROFIT LOG ====');
  data.profitLog.forEach(entry => {
    lines.push(`${entry.date} | ${entry.type === "run" ? "EXPENSE" : "INCOME"} | $${entry.amount.toFixed(2)} | ${entry.desc}`);
  });
  lines.push('');
  lines.push('==== TOTAL EXPENSES ====');
  lines.push(`Total Expenses: $${data.expenses.toFixed(2)}`);
  lines.push('==== TOTAL PROFIT ====');
  lines.push(`Total Profit: $${data.profit.toFixed(2)}`);
  let blob = new Blob([lines.join('\n')], {type: 'text/plain'});
  let a = document.createElement('a');
  a.download = 'Mycoify-export.txt';
  a.href = URL.createObjectURL(blob);
  a.click();
}
function importTextFile() {
  let input = document.createElement('input');
  input.type = 'file';
  input.accept = 'text/plain';
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const text = await file.text();

    // Parse the imported text!
    try {
      const lines = text.split(/\r?\n/);
      let section = '';
      let supplies = [];
      let spawn = [];
      let colonizing = [];
      let runs = [];
      let profitLog = [];
      let expenses = 0, profit = 0;
      let tubFlushes = {};
      let mushrooms = 0;

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        if (line.startsWith('====')) {
          section = line.replace(/=/g, '').trim().toLowerCase();
          continue;
        }
        // Supplies
        if (section.startsWith('supplies')) {
          // Format: name | qty | unit | cost | DELETED
          const parts = line.split('|').map(s => s.trim());
          if (parts.length >= 4) {
            let [name, qty, unit, unitCost, deleted] = parts;
            supplies.push({
              name,
              qty: parseFloat(qty),
              unit,
              unitCost: parseFloat(unitCost),
              deleted: (deleted && deleted.toUpperCase() === 'DELETED') ? true : false
            });
          }
        }
        // Spawn
        else if (section.startsWith('spawn')) {
          // Format: strain | jarId | date | DELETED
          const parts = line.split('|').map(s => s.trim());
          if (parts.length >= 3) {
            let [strain, jarId, date, deleted] = parts;
            spawn.push({
              strain,
              jarId,
              date,
              deleted: (deleted && deleted.toUpperCase() === 'DELETED') ? true : false
            });
          }
        }
        // Colonizing
        else if (section.startsWith('colonizing')) {
          // Format: strain | tubId | inocDate | outtakeDate | spawnJarId | DELETED
          const parts = line.split('|').map(s => s.trim());
          if (parts.length >= 5) {
            let [strain, tubId, inocDate, outtakeDate, spawnJarId, deleted] = parts;
            colonizing.push({
              strain,
              tubId,
              inocDate,
              outtakeDate,
              spawnJarId,
              deleted: (deleted && deleted.toUpperCase() === 'DELETED') ? true : false
            });
          }
        }
        // Runs
        else if (section.startsWith('runs')) {
          // Format: name | date | used | runDate | totalCost
          // used: e.g. "Peat moss:2 kg, Vermiculite:1.5 kg"
          const parts = line.split('|').map(s => s.trim());
          if (parts.length >= 5) {
            let [name, timeStr, usedStr, runDate, totalCostStr] = parts;
            let time = Date.parse(timeStr) || Date.now();
            let suppliesUsed = [];
            if (usedStr) {
              let usedArr = usedStr.split(',').map(s => s.trim());
              for (let j = 0; j < supplies.length; j++) {
                let entry = usedArr.find(x => x.startsWith(supplies[j].name + ':'));
                if (entry) {
                  let [, qtyUnit] = entry.split(':');
                  let qty = parseFloat(qtyUnit);
                  suppliesUsed[j] = isNaN(qty) ? 0 : qty;
                } else {
                  suppliesUsed[j] = 0;
                }
              }
            }
            let totalCost = parseFloat(totalCostStr) || 0;
            runs.push({ name, time, suppliesUsed, runDate, totalCost, deleted: false });
          }
        }
        // PROFIT LOG
        else if (section.startsWith('profit log')) {
          // Format: date | EXPENSE/INCOME | $amount | desc
          const parts = line.split('|').map(s => s.trim());
          if (parts.length >= 4) {
            let [date, typeStr, amountStr, desc] = parts;
            let amount = parseFloat(amountStr.replace(/[^0-9\.-]/g, ''));
            let type = typeStr === "EXPENSE" ? "run" : "flush";
            profitLog.push({ date, type, amount, desc });
          }
        }
        // TOTAL EXPENSES
        else if (section.startsWith('total expenses')) {
          let m = line.match(/Total Expenses:\s*\$([0-9\.,\-]+)/i);
          if (m) expenses = parseFloat(m[1].replace(',', '')) || 0;
        }
        // TOTAL PROFIT
        else if (section.startsWith('total profit')) {
          let m = line.match(/Total Profit:\s*\$([0-9\.,\-]+)/i);
          if (m) profit = parseFloat(m[1].replace(',', '')) || 0;
        }
        // (optionally add parsing of tubFlushes and harvestedTubs if you export/import them in the future)
      }

      // Calculate mushrooms from profitLog (if possible)
      mushrooms = 0;
      profitLog.forEach(entry => {
        if (entry.type === "flush") {
          // Try to extract grams from desc, fallback to not increasing mushrooms
          let m = entry.desc.match(/Harvested\s+([\d\.]+)g/i);
          if (m) mushrooms += parseFloat(m[1]);
        }
      });

      // Update the data object
      data.supplies = supplies;
      data.spawn = spawn;
      data.colonizing = colonizing;
      data.runs = runs;
      data.profitLog = profitLog;
      data.expenses = expenses;
      data.profit = profit;
      data.mushrooms = mushrooms;

      // Clear fruiting, harvestedTubs, tubFlushes (you may extend this if you export/import those)
      data.fruiting = [];
      data.harvestedTubs = [];
      data.tubFlushes = {};

      saveData();
      // Re-render everything
      updateDashboard();
      renderSupplies();
      renderRuns();
      renderSpawn();
      renderColonizing();
      renderFruiting();
      renderRunSuppliesTable();
      updateColonizeSpawnSelect();
      updateFruitingTubSelect();

      showNotification('Import successful!');
    } catch (err) {
      console.error(err);
      showNotification('Failed to import. File format may be invalid.', true);
    }
  };
  input.click();
}
</script>
</body>
</html>
